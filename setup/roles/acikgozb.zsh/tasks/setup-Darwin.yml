- name: Install zsh via brew.
  community.general.homebrew:
    name: zsh
    state: present

- name: Verify that zsh is installed successfully.
  block:
    - name: Get info about the version.
      ansible.builtin.shell:
        cmd: zsh --version
      register: zsh_version_out
      changed_when: true

    - name: Ensure that version is outputted successfully.
      ansible.builtin.debug:
        msg: "zsh is installed successfully. Version: {{ zsh_version_out.stdout }}"
      when: zsh_version_out is defined

- name: Create a symlink for .zshenv.
  become_user: "{{ lookup('env', 'USER') }}"
  ansible.builtin.file:
    src: ~/.config/zsh/.zshenv
    dest: ~/.zshenv
    force: true
    state: link

- name: Install Starship via brew.
  community.general.homebrew:
    name: starship
    state: present

- name: Verify that Starship is installed successfully.
  block:
    - name: Get info about the version.
      ansible.builtin.shell:
        cmd: starship --version
      register: starship_version_out
      changed_when: true

    - name: Ensure that version is outputted successfully.
      ansible.builtin.debug:
        msg: "Starship is installed successfully. Version: {{ starship_version_out.stdout }}"
      when: starship_version_out is defined

- name: Remove old bash files.
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - .profile
    - .bashrc
    - .bash_history
    - .bash_logout

- name: Change $USER shell to zsh.
  ansible.builtin.user:
    name: "{{ lookup('env', 'USER') }}"
    shell: /bin/zsh

- name: Create .zsh under $HOME to house 3rd party zsh plugins.
  become_user: "{{ lookup('env', 'USER') }}"
  ansible.builtin.file:
    path: "~/.zsh"
    state: directory

- name: Clone 3rd party zsh plugins under .zsh.
  become_user: "{{ lookup('env', 'USER') }}"
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "~/.zsh/{{ item.dest }}"
    clone: true
  with_items:
    - {repo: 'https://github.com/zsh-users/zsh-autosuggestions.git', dest: "zsh-autosuggestions"}
    - {repo: 'https://github.com/jeffreytse/zsh-vi-mode.git', dest: "zsh-vi-mode"}
